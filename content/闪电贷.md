---
title: 闪电贷
date: 2023-11-16
tags: []
categories: []
toc: true
mathjax: true
comments: true
description: 
---

闪电贷（Flash Loan）是一种基于区块链的借贷方式，它允许用户在一笔交易中借入和归还大量的资产，而无需提供任何抵押或信用。闪电贷的特点是：

- 速度快：闪电贷只在一个区块内完成借贷操作，所以称为闪电贷。如果借款人不能在同一个区块内归还借款，那么整个交易将被撤销，就像没有发生过一样 。
- 风险低：闪电贷不需要任何抵押或信用，因为它是无条件的。借款人只要能在规定的时间内还款，就可以借到任意数量的资产 。如果用户无法在规定时间内还款，那么交易会被撤销，用户将损失交易费用和利息。出借方也不会损失任何资产 。
- 用途广：闪电贷可以用于各种目的，例如套利、抵押、偿还债务、参与拍卖等 。闪电贷可以让用户利用市场的价格差异，实现无风险的利润 。

## 闪电贷攻击

原文：[什么是DeFi中的闪电贷？ | Binance Academy](https://academy.binance.com/zh/articles/what-are-flash-loans-in-defi#header-3)

我们将通俗地介绍。

- 第一次：攻击者借了很多以太币，然后用一部分去卖空以太币，兑换了一种叫包装比特币WBTC的代币。这样一来，WBTC的价格就涨了很多。然后，攻击者又用剩下的以太币去借了更多的WBTC，再卖掉换成以太币。这样一来，攻击者就赚了很多钱，还了借的以太币，还剩下很多以太币。
- 第二次：攻击者借了很多以太币，然后用一部分去买了一种叫sUSD的代币。这种代币本来应该和美元一样价值，但是因为攻击者买了很多，所以sUSD的价格就涨了一倍。然后，攻击者又用剩下的以太币去借了更多的以太币，因为他们有很多sUSD可以作为抵押。再然后，攻击者把借的以太币和买的sUSD都卖掉换成以太币。这样一来，攻击者也赚了很多钱，还了借的以太币，还剩下很多以太币。

简单来说，就是攻击者利用借的钱去操纵市场，让一些代币的价格变得不合理，然后再利用这些价格差异来赚钱。

闪电贷的漏洞主要是由于它可以提供大量的资金，从而放大了一些已有的合约漏洞或逻辑缺陷，导致了一系列的闪电贷攻击。作为开发者，需要注意以下几种常见的闪电贷漏洞：

- 价格获取逻辑存在问题：一些合约直接读取了去中心化交易所（DEX）的代币数量，将两者之商作为代币的价格。这样的逻辑容易被闪电贷攻击者利用，通过借用大量的代币，操纵DEX的价格，从而实现双花或者套利。作为开发者，应该使用去中心化的预言机（oracle）来获取更可靠的价格信息，或者使用时间加权平均价格（TWAP）来抵消价格波动。

- 抵押或奖励逻辑存在问题：一些合约在抵押或奖励的过程中，会立即将代币转给用户地址，而不进行任何校验或限制。这样的逻辑容易被闪电贷攻击者利用，通过借用大量的代币，重复调用抵押或奖励的函数，从而获得超额的收益。作为开发者，应该在抵押或奖励的过程中，增加一些条件或限制，例如检查用户的抵押率、奖励次数、奖励金额等。

- 重入攻击：一些合约在执行闪电贷的过程中，会先转账后记账，或者先执行用户的回调函数后再进行校验。这样的逻辑容易被闪电贷攻击者利用，通过借用大量的代币，利用回调函数重复调用闪电贷的函数，从而实现多次借款或者不还款。作为开发者，应该在执行闪电贷的过程中，先进行校验后转账，或者使用互斥锁（mutex）来防止重入。
